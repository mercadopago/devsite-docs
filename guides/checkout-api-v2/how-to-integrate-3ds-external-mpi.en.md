# How to integrate 3DS with external MPI on ----[mlb]---- Checkout Transparente------------ ----[mla, mlm, mlu, mco, mlc, mpe]---- Checkout API ------------

[3DS authentication](/developers/en/docs/checkout-api/how-tos/improve-payment-approval/3ds), or 3-D Secure, is a protocol developed to increase security in online debit or credit card transactions. This protocol adds an extra layer of verification, allowing both the card issuing entity and the bank to which it belongs to authenticate the transaction prior to its conclusion.

----[mlb]---- Checkout Transparente------------ ----[mla, mlm, mlu, mco, mlc, mpe]---- Checkout API ------------ Checkout API offers the possibility to configure 3DS payments in two different ways:
 * **Integrating 3DS authentication when creating a payment:** he protocol will be executed as part of the payment processing.  
 * **By previously performing a 3DS authentication through an external MPI provider:** the 3DS payment will be generated by providing previously validated data through an external flow, optimizing the payment creation process, as shown in the diagram below.

![External 3DS authentication flow](/images/api/3ds-external-flow-en.png)

If you want to integrate 3DS when creating a payment, access [our documentation](/developers/en/docs/checkout-api/how-tos/integrate-3ds). 

If, instead, you want to integrate 3DS with an external MPI on ----[mlb]---- Checkout Transparente------------ ----[mla, mlm, mlu, mco, mlc, mpe]---- Checkout API ------------, follow the steps listed below.


## 1. Authenticate the transaction
To create 3DS payments with an external MPI, you must **authenticate the transaction before creating the payment**. You can do this through a MPI provider of your choice, and it will be performed outside the Mercado Pago environment.

This authentication will return a series of data, such as a cryptogram or the unique transaction identifier attributed by 3DS, which you must include in the next step.

> WARNING
>
> Important
>
> Keep in mind that, if the transaction is not correctly authenticated, the payment will be rejected by the card issuing bank, so you must make sure to include all the information requested by your provider appropriately and to **inform that it will be processed by Mercado Pago**. If there’s any doubts about this process, please contact a Comercial or Integrations representative.

## 2. Create previously authenticated payment
Use the parameters returned by the external MPI provider in the previous step to create a payment. This must be done by incorporating the new `payment_method.data.authentication` object into the usual flow, which will contain the values ​​received during authentication.

To do this, you can send a **POST** with the new required attributes to the [/v1/payments](/developers/en/reference/payments/_payments/post) endpoint and execute the request or, if you prefer, send the information using our SDKs. You can see a detailed description for these fields in the table below.

[[[
```php
<?php
  use MercadoPago\Client\Payment\PaymentClient;
  MercadoPagoConfig::setAccessToken("YOUR_ACCESS_TOKEN");

  $client = new PaymentClient();
  $request_options = new RequestOptions();
  $request_options->setCustomHeaders(["X-Idempotency-Key: <SOME_UNIQUE_VALUE>"]);

  $payment = $client->create([
    "transaction_amount" => <TRANSACTION_AMOUNT>,
    "token" => "CARD_TOKEN",
    "description" => "<DESCRIPTION>",
    "installments" => <INSTALLMENTS_NUMBER>,
    "payment_method_id" => "<PAYMENT_METHOD_ID>",
    "issuer_id" => "<ISSUER_ID>",
    "payer" => [
      "email" => $_POST['email']
    ],
    "payment_method" => [
      "type" => 'credit_card',
      "data" => [
// Attributes corresponding with the authentication
        "authentication"  => [
        "type" => 'external_threeds',
        "cryptogram" => '<<String>>',
        "three_ds_server_trans_id" => '<<String>>',
        "eci" => '<<String>>',
        "ds_trans_id" => '<<String>>',
        "acs_trans_id" => '<<String>>',
        "three_ds_version" => '<<String>>',
        "authentication_status" => '<<String>>',
      ]
    ]
  ], $request_options);
  echo implode($payment);
?>
```
```java
Map<String, String> customHeaders = new HashMap<>();
    customHeaders.put("x-idempotency-key", <SOME_UNIQUE_VALUE>);
MPRequestOptions requestOptions = MPRequestOptions.builder()
    .customHeaders(customHeaders).build();
MercadoPagoConfig.setAccessToken("<ENV_ACCESS_TOKEN>");

    PaymentClient client = new PaymentClient();
// Attributes corresponding with the authentication
    PaymentAuthenticationRequest authentication = 
PaymentAuthenticationRequest.builder()
        .type("external_threeds")
        .cryptogram("<<String>>")
        .threeDsServerTransId("<<String>>")
        .eci("<<String>>")
        .dsTransId("<<String>>")
        .acsTransId("<<String>>")
        .threeDsVersion("<<String>>")
        .authenticationStatus("<<String>>")
        .build();
PaymentDataRequest data = PaymentDataRequest.builder()
        .authentication(authentication).build();
PaymentMethodRequest paymentMethod = PaymentMethodRequest
        .builder().data(data).type("credit_card").build();

PaymentCreateRequest createRequest =
    PaymentCreateRequest.builder()
        .transactionAmount(new BigDecimal(<TRANSACTION_AMOUNT>))
        .token("<CARD_TOKEN>")
        .description("<DESCRIPTION>")
        .installments(<INSTALLLMENTS_NUMBER>)
        .paymentMethodId("<PAYMENT_METHOD_ID>")
        .payer(PaymentPayerRequest.builder().email("<BUYER_EMAIL>")
             .build())
        .paymentMethod(paymentMethod)
        .build();

client.create(createRequest, requestOptions);
```
```csharp
using MercadoPago.Config;
using MercadoPago.Client.Payment;
using MercadoPago.Resource.Payment;
MercadoPagoConfig.AccessToken = "<ENV_ACCESS_TOKEN>";

var requestOptions = new RequestOptions();
requestOptions.CustomHeaders.Add("x-idempotency-key", "<SOME_UNIQUE_VALUE>");

var request = new PaymentCreateRequest
{
    TransactionAmount = <TRANSACTION_AMOUNT>,
    Token = "<CARD_TOKEN>",
    Description = "<DESCRIPTION>",
    Installments = <INSTALLLMENTS_NUMBER>,
    Payer = new PaymentPayerRequest
    {
        Email = "<BUYER_EMAIL>",
    },
    PaymentMethodRequest = new PaymentMethodRequest
    {
        Type = "credit_card",
        Data = new PaymentDataRequest

// Attributes corresponding with the authentication
        {
            Authentication = new PaymentAuthenticationRequest
            {
                Type = "external_threeds",
                Cryptogram = "<<String>>",
                ThreeDsServerTransId = "<<String>>",
                Eci = "<<String>>",
                DsTransId = "<<String>>",
                AcsTransId =  "<<String>>",
                ThreeDsVersion = "<<String>>",
                AuthenticationStatus = "<<String>>"
            }
        }
    }
};
var client = new PaymentClient();
Payment payment = await client.CreateAsync(request, requestOptions);
```
```node
import { MercadoPagoConfig, Payment } from 'mercadopago';

const client = new MercadoPagoConfig({ accessToken: '<ENV_ACCESS_TOKEN>' });
const payment = new Payment(client);

const body = {
  transaction_amount: <TRANSACTION_AMOUNT>,
  token: '<CARD_TOKEN>',
  description:  '<DESCRIPTION>',
  installments: <INSTALLMENTS_NUMBER>,
  payment_method_id: '<PAYMENT_METHOD_ID>',
  issuer_id: '<ISSUER_ID>',
  payer: {
    email: '<BUYER_EMAIL>',
  },
  payment_method: {
    type: 'credit_card',
    data: {
// Attributes corresponding with the authentication
      authentication: {
        type: 'external_threeds',
        cryptogram: '<<String>>',
        three_ds_server_trans_id: '<<String>>',
        eci: '<<String>>',
        ds_trans_id: '<<String>>',
        acs_trans_id: '<<String>>',
        three_ds_version: '<<String>>',
        authentication_status: '<<String>>',
      }
    }
  }
}
payment.create({ body: body, requestOptions: { idempotencyKey: '<SOME_UNIQUE_VALUE>' } }).then(console.log).catch(console.log);
```
```ruby
require 'mercadopago'
sdk = Mercadopago::SDK.new('<ENV_ACCESS_TOKEN>')

custom_headers = {
 'x-idempotency-key': '<SOME_UNIQUE_VALUE>'
}

custom_request_options = Mercadopago::RequestOptions.new(custom_headers: custom_headers)

payment_request = {
  token: '<CARD_TOKEN>',
  installments: <INSTALLLMENTS_NUMBER>,
  transaction_amount: <TRANSACTION_AMOUNT>,
  description: '<DESCRIPTION>',
  payer: {
    email: '<BUYER_EMAIL>',
  },
  payment_method: {
    type: 'credit_card',
    data: {
# attributes corresponding with the authentication
      authentication: {
        type: 'external_threeds',
        cryptogram: '<<String>>',
        three_ds_server_trans_id: '<<String>>',
        eci: '<<String>>',
        ds_trans_id: '<<String>>',
        acs_trans_id: '<<String>>',
        three_ds_version: '<<String>>',
        authentication_status: '<<String>>'
      }
    }
  }
}
payment_response = sdk.payment.create(payment_request,
                                      custom_request_options)

payment = payment_response[:response]

```
```python
import mercadopago
sdk = mercadopago.SDK("<ENV_ACCESS_TOKEN>")

request_options = mercadopago.config.RequestOptions()
request_options.custom_headers = {
    'x-idempotency-key': '<SOME_UNIQUE_VALUE>'
}

payment_data = {
    "transaction_amount": <TRANSACTION_AMOUNT>,
    "token": "<CARD_TOKEN>",
    "description": "<DESCRIPTION>",
    "installments": <INSTALLLMENTS_NUMBER>,
    "payer": {
        "email": "<BUYER_EMAIL>",
    },
    "payment_method": {
        "type": "credit_card",
        "data": {
# authentication attributes
            "authentication": {
                "type": "external_threeds",
                "cryptogram": "<<String>>",
                "three_ds_server_trans_id": "<<String>>",
                "eci": "<<String>>",
                "ds_trans_id": "<<String>>",
                "acs_trans_id": "<<String>>",
                "three_ds_version": "<<String>>",
                "authentication_status": "<<String>>"
            }
        }
    }
}

payment_response = sdk.payment().create(payment_data,
                                        request_options)

payment = payment_response["response"]
```
```curl
curl --location 'https://api.mercadopago.com/v1/payments' \
--header 'x-idempotency-key: {IDEMPOTENCY_KEY} \
--header 'Authorization: Bearer {ACCESS_TOKEN}' \
--header 'Content-Type: application/json' \
--data-raw '{
   "description": "{PAYMENT_DESCRIPTION}",
   "installments": 1,
   "payer": {
       "first_name": "{FIRST_NAME}",
       "last_name": "{LAST_NAME}",
       "address": {},
       "identification": {
           "number": "{IDENTIFICATION_NUMBER}",
           "type": "{IDENTIFICATION_TYPE}"
       },
       "email": "{EMAIL}"
   },
   "payment_method_id": "{PAYMENT_METHOD_ID}",
   "token": "{CARD_TOKEN}"
   "payment_method": {
      "type": "credit_card",
      "data": {
         "authentication": {
            "type": "external_threeds",
            "cryptogram": "<<String>>",
            "three_ds_server_trans_id": "<<String>>",
            "eci": "<<String>>",
            "ds_trans_id": "<<String>>",
            "acs_trans_id": "<<String>>",
            "three_ds_version": "<<String>>",
            "authentication_status": "<<String>>"
         }
      }
   },
   "statement_descriptor": "{STATEMENT_DESCRIPTOR}",
   "transaction_amount": {AMOUNT}
}'

```
]]]


| Attribute | Mandatory/optional | Description | Example |
|---|---|---|---|
| `type` | Mandatory | Flags that the transaction is previously authenticated with an external MPI. It must be `external_threeds`. | `external_threeds` |
| `cryptogram` | Mandatory  | It is a specific value of the payment system, provided as part of the Access Control Server (ACS) registry for every admitted Directory Server (DS). | `AJkBAScICQBBBDIASECYdYg3CXg=` |
| `three_ds_server_trans_id` | Optional | Universally unique transaction identifier assigned by the 3DS Server to identify it.| `c20b7628-2061-434b-8ad4-1daff5a272f9` |
| `eci` | Mandatory | E-commerce indicator, a specific value returned by ACS to indicate the cardholder’s authentication attempt. |  `00` |
| `ds_trans_id` | Mandatory |It’s a universally unique transaction identifier assigned by the DS to identify it. | `aba1d1a1-1cec-1f11-1fda-1e1c01bf101a` |
| `acs_trans_id` | Optional | It’s a universally unique transaction identifier assigned by ACS to identify it. | `1d10bbb1-1dbb-1c11-a111-1111f1111ad1` |
| `three_ds_version` | Mandatory | 3DS version identifier. | `2.2.0` |
| `authentication_status` | Optional | Authentication status, also known as `transStatus` in the 3DS protocol. It must be `Y`, for a fully authenticated response, or `A`, pfor an attempted authentication response | `Y` |

### Possible responses
If the request was correct, you will receive a response similar to the following, with `status=approved`, and a `status_detail=accredited`, which will indicate that the transaction was approved.

```json
{
    "send_advice": false,
    "id": 69306088555,
    "date_created": "2023-12-26T18:04:10.711-04:00",
    "date_approved": "2023-12-26T18:04:11.351-04:00",
    "date_last_updated": "2023-12-26T18:04:11.351-04:00",
    "money_release_date": "2023-12-26T18:04:11.351-04:00",
    "collector_id": 219830831,
    "operation_type": "regular_payment",
    "issuer_id": "205",
    "payment_method_id": "visa",
    "payment_type_id": "credit_card",
    "status": "approved",
    "status_detail": "accredited",
    "currency_id": "COP",
    "description": "Payment test",
    "live_mode": true,
    "payer": {
        "phone": {},
        "id": "1608786725",
        "email": "test_user_11653412@testuser.com",
        "identification": {
            "number": "123456767",
            "type": "CC"
        }
    },
    "order": {},
    "transaction_amount": 1234.56,
    "transaction_amount_refunded": 0,
    "coupon_amount": 0,
    "transaction_details": {
        "acquirer_reference": null,
        "external_resource_url": null,
        "financial_institution": null,
        "installment_amount": 1234.56,
        "net_received_amount": 234.17,
        "overpaid_amount": 0,
        "payable_deferral_period": null,
        "payment_method_reference_id": null,
        "total_paid_amount": 1234.56
    },
    "fee_details": [
        {
            "type": "mercadopago_fee",
            "fee_payer": "collector",
            "amount": 1000.39
        }
    ],
    "captured": true,
    "binary_mode": true,
    "statement_descriptor": "Mercadopago*fake",
    "installments": 1,
    "card": {
        "first_six_digits": "401354",
        "last_four_digits": "6260",
        "expiration_month": 11,
        "expiration_year": 2025,
        "date_last_updated": "2023-12-26T18:04:10.000-04:00",
        "date_created": "2023-12-26T18:04:10.000-04:00",
        "cardholder": {
            "identification": {
                "number": "123456767",
                "type": "CC"
            },
            "name": "APRO"
        }
    },
    "refunds": [],
    "additional_info": {
        "authentication_code": null,
        "available_balance": null,
        "nsu_processadora": null
    },
    "processing_mode": "aggregator",
    "taxes_amount": 0,
    "shipping_amount": 0,
    "is_test": false,
    "authorization_code": "301299"
}
```

The status `rejected`, on the other hand, will indicate that the transaction was rejected. In this last case, you can verify the reasons for rejection when creating a charge by accessing [our documentation](/developers/en/docs/checkout-api/response-handling/collection-results).

